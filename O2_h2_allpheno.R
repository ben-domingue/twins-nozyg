load("twins.Rdata")

y<-x[,c("height_1","height_2")]
xx<-x[,c("age","survey_year")]
z<-residualize(y=y,x=xx)
x$htr_1<-z[,1]
x$htr_2<-z[,2]
##
y<-x[,c("weight_1","weight_2")]
xx<-x[,c("age","survey_year")]
z<-residualize(y=y,x=xx)
x$wtr_1<-z[,1]
x$wtr_2<-z[,2]




f<-function(nm,rho,x,...) {
    nm1<-paste(nm,'_1',sep="")
    nm2<-paste(nm,'_2',sep="")
    x<-x[!is.na(x[[nm1]]) & !is.na(x[[nm2]]),]
    herit.ht<-h2(x,nm1,nm2,rho=rho,...)
}

#ACE and h2 for children under two and older than two for residualized height, haz, residualized weight, waz, whz, birthweight, and hemoglobin. 
###
nms<-c("height","haz","htr","del","wtr","waz","whz","birthweight","hemoglobin")

y<-x[!is.na(x$age),]
y1<-y[y$age<24,]
y2<-y[y$age>=24,]

#####################################################
##main, table 2
out<-list()
for (nm in nms) {
    h2.all<-f(nm=nm,rho=0.5,x=x,printz=TRUE)
    print(nm)
    h2.young<-f(nm=nm,rho=0.5,x=y1,printz=TRUE)
    print(nm)
    h2.old<-f(nm=nm,rho=0.5,x=y2,printz=TRUE)
    out[[nm]]<-list(h2.all,h2.young,h2.old)
}

#####################################################
##bootstrap
bs<-function(dum,x,nm='del',nn=10,...) {
    z<-x[,paste(nm,c("_1","_2"),sep="")]
    z<-x[rowSums(is.na(z))==0,]
    ii<-sample(1:nrow(z),nrow(z),replace=TRUE)
    f(z[ii,],nm=nm,...)
}
gg<-function(est) {
    est<-do.call("rbind",est)
    apply(est,2,quantile,c(.025,.975))
}

nm<-"del"
nn<-100
h2.all<-f(nm=nm,rho=0.5,x=x,printz=TRUE)
library(parallel)
ci.all<-mclapply(1:nn,bs,mc.cores=25,nm=nm,rho=0.5,x=x,printz=TRUE)
##
h2.young<-f(nm=nm,rho=0.5,x=y1,printz=TRUE)
ci.young<-mclapply(1:nn,bs,mc.cores=25,nm=nm,rho=0.5,x=y1,printz=TRUE)
##
h2.old<-f(nm=nm,rho=0.5,x=y2,printz=TRUE)
ci.old<-mclapply(1:nn,bs,mc.cores=25,nm=nm,rho=0.5,x=y2,printz=TRUE)

h2.all
gg(ci.all)
h2.young
gg(ci.young)
h2.old
gg(ci.old)

z<-list(h2.all,gg(ci.all),h2.young,gg(ci.young),h2.old,gg(ci.old))
tab<-do.call("rbind",z)
write.csv(tab,'')

#####################################################

## out <-
## list(height = list(c(h2 = 0.0660712337794171, 14.2368351319665, 
## 200.513216127961, 0.727007629225406), c(h2 = 0.113592684985482, 
## 10.1646913996312, 78.6509253985303, 0.668062550824278), c(h2 = 0.224811677367671, 
## 17.5696829049529, 59.7820934221127, 0.801116399313354)), haz = list(
##     c(h2 = 0.48531115070713, 1.40486562728834, 1.41430143431992, 
##     0.0756059623401013), c(h2 = 0.507325604441379, 1.68710226972287, 
##     1.52676860957087, 0.111611325730293), c(h2 = 0.452737381322183, 
##     1.13927419577756, 1.32378880770167, 0.0533499166344177)), 
##     htr = list(c(h2 = 0.384718239624026, 14.2424565835898, 22.0503365460643, 
##     0.727693857156125), c(h2 = 0.309588660311121, 10.1776214220387, 
##     22.0311770447005, 0.665859835702209), c(h2 = 0.432818875682359, 
##     17.5476803108884, 22.1927761689679, 0.802323183400479)), 
##     del = list(c(h2 = 0.458341522465993, 0.4592351488224, 0.516480469245613, 
##     0.0262340773285531), c(h2 = 0.458592531038675, 0.470986244321129, 
##     0.522944841472681, 0.0330944596383912), c(h2 = 0.4560635847381, 
##     0.44695417910072, 0.511982751659082, 0.021089087667845)), 
##     wtr = list(c(h2 = 0.509810295898917, 2.01187735928814, 1.7746862429144, 
##     0.159761875082536), c(h2 = 0.44716937425014, 1.20005302192111, 
##     1.37906299896215, 0.10454947819857), c(h2 = 0.518123118936423, 
##     2.59717285402731, 2.17132393121057, 0.244159008540736)), 
##     waz = list(c(h2 = 0.540918773249134, 1.17721913544614, 0.882706481817415, 
##     0.116406937021713), c(h2 = 0.526559096079326, 1.36592938376629, 
##     1.07386261076567, 0.154274642882114), c(h2 = 0.547120111146233, 
##     0.979999401442177, 0.714922457589757, 0.0962742265753925)), 
##     whz = list(c(h2 = 0.926121485447132, 3.47403013590006, 0.124522933982314, 
##     0.152607215771509), c(h2 = 0.992632552409101, 4.74816240978489, 
##     -0.168143139464548, 0.203384616909817), c(h2 = 0.914769171684979, 
##     2.78828513461735, 0.130514751417119, 0.129275214136874)), 
##     birthweight = list(c(h2 = 0.7088739469657, 365087.412804448, 
##     142914.52715674, 7022.50742778251), c(h2 = 0.680358834355086, 
##     289856.615707596, 124189.516770649, 11988.7789113477), c(h2 = 0.737472840869186, 
##     345941.123420208, 115849.975990159, 7298.88499161019)), hemoglobin = list(
##         c(h2 = 0.605068344980738, 2.11172982269696, 0.93957110161483, 
##         0.43876733031519), c(h2 = 0.588268984821156, 2.14356960742793, 
##         1.06022615747927, 0.440063868589567), c(h2 = 0.692474031800526, 
##         2.0497961212004, 0.46482717257866, 0.445482106665564)))




## for (i in 1:length(out)) out[[i]]<-do.call("c",out[[i]])
## mat<-do.call("rbind",out)
## write.csv(mat,'')
